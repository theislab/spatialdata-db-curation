---
layout: default
title: SpatialData-DB Curation
---

<main class="page-content" aria-label="Content">
  <div class="wrapper">
    <h1>SpatialData-DB Curation</h1>
    <p>Explore the dataset registry viewer below.</p>

    <style>
      .wrap { max-width: 1200px; margin: 0 auto; }
      input, select { padding: 8px 10px; font-size: 14px; }
      table { width: 100%; border-collapse: collapse; margin-top: 16px; }
      .wrapper { max-width: none; padding-left: 24px; padding-right: 24px; }
      th, td { padding: 8px; border-bottom: 1px solid #e5e7eb; text-align: left; font-size: 13px; }
      tr.highlight { background: #fef3c7; }
      .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
      .muted { color: #6b7280; font-size: 12px; }
      .pill { display: inline-block; padding: 2px 6px; border: 1px solid #e5e7eb; border-radius: 999px; margin-right: 4px; font-size: 11px; }
      td, th { text-align: left; }
      .rowcount { margin-left: auto; }
    </style>

    <div class="wrap">
      <div class="controls">
        <input id="q" type="text" placeholder="Filter by text (name, manufacturer, tags, notes)" size="40" />
        <input id="src" type="text" placeholder="Paste DOI or URL to check" size="40" />
        <button id="check">Check</button>
        <span class="rowcount muted" id="rowcount"></span>
      </div>

      <table id="tbl">
        <thead>
          <tr>
            <th>Status</th>
            <th>Name</th>
            <th>Manufacturer</th>
            <th>Product</th>
            <th>Tags</th>
            <th>Primary source</th>
            <th>Lamin link</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <p class="muted">Data source: <code>registry/datasets.csv</code>. To add new datasets, open a PR or use the repo template.</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
      const Q = document.getElementById("q");
      const SRC = document.getElementById("src");
      const BTN = document.getElementById("check");
      const TBL = document.getElementById("tbl").querySelector("tbody");
      const ROWCOUNT = document.getElementById("rowcount");

      let rows = [];
      let fpIndex = new Map(); // fingerprint -> [dataset_id]

      function text(x) { return x == null ? "" : String(x); }

      function canonicalizeDoi(raw) {
        if (!raw) return null;
        let s = String(raw).trim();
        if (!s) return null;
        s = s.replace("https://doi.org/", "").replace("http://doi.org/", "");
        s = s.replace("doi:", "").trim().toLowerCase();
        return s || null;
      }

      function canonicalizeUrl(raw) {
        if (!raw) return null;
        let s = String(raw).trim();
        if (!s) return null;
        if (!s.startsWith("http://") && !s.startsWith("https://")) s = "https://" + s;
        try {
          const u = new URL(s);
          let host = u.host.toLowerCase();
          if (host.startsWith("www.")) host = host.slice(4);
          const params = [...u.searchParams.entries()].filter(([k, _v]) => {
            const kl = k.toLowerCase();
            if (kl === "gclid" || kl === "fbclid" || kl === "yclid" || kl === "ref" || kl === "ref_") return false;
            if (kl.startsWith("utm_") || kl.startsWith("mc_")) return false;
            return true;
          }).sort(([a], [b]) => a.localeCompare(b));
          const usp = new URLSearchParams(params);
          let path = u.pathname.replace(/\/+/, "/");
          if (path.endsWith("/") && path !== "/") path = path.slice(0, -1);
          const normalized = "https://" + host + path + (usp.toString() ? "?" + usp.toString() : "");
          return normalized;
        } catch (e) {
          return null;
        }
      }

      function canonicalSource(raw) {
        const d = canonicalizeDoi(raw);
        if (d != null) return "doi:" + d;
        const u = canonicalizeUrl(raw);
        if (u != null) return u;
        return null;
      }

      async function sha1Hex(str) {
        const enc = new TextEncoder().encode(str);
        const buf = await crypto.subtle.digest("SHA-1", enc);
        const arr = Array.from(new Uint8Array(buf));
        return arr.map(b => b.toString(16).padStart(2, "0")).join("").slice(0, 12);
      }

      function render(data) {
        TBL.innerHTML = "";
        let shown = 0;
        const q = Q.value.trim().toLowerCase();
        for (const r of data) {
          const hay = (
            text(r.name) + " " + text(r.manufacturer) + " " + text(r.product) + " " + text(r.tags) + " " + text(r.primary_source) + " " + text(r.lamin_link)
          ).toLowerCase();
          if (q && !hay.includes(q)) continue;
          const tr = document.createElement("tr");
          const tagsHtml = text(r.tags).split(",").filter(Boolean).map(t => `<span class="pill">${t.trim()}</span>`).join(" ");
          const src = text(r.primary_source);
          const srcHtml = src ? `<a href="${src}" target="_blank" rel="noopener">${src}</a>` : "";
          const lamin = text(r.lamin_link);
          const laminHtml = lamin ? `<a href="${lamin}" target="_blank" rel="noopener">${lamin}</a>` : "";
          tr.innerHTML = `
            <td>${text(r.status)}</td>
            <td>${text(r.name)}</td>
            <td>${text(r.manufacturer)}</td>
            <td>${text(r.product)}</td>
            <td>${tagsHtml}</td>
            <td>${srcHtml}</td>
            <td>${laminHtml}</td>
          `;
          TBL.appendChild(tr);
          shown += 1;
        }
        ROWCOUNT.textContent = `${shown} of ${data.length}`;
      }

      function buildFingerprintIndex(data) {
        fpIndex = new Map();
        for (const r of data) {
          const pf = text(r.primary_fingerprint);
          const dsid = text(r.dataset_id);
          if (pf) {
            if (!fpIndex.has(pf)) fpIndex.set(pf, new Set());
            fpIndex.get(pf).add(dsid);
          }
        }
      }

      async function checkSource() {
        const raw = SRC.value.trim();
        if (!raw) return;
        const c = canonicalSource(raw);
        if (c == null) {
          alert("Does not look like a DOI or URL.");
          return;
        }
        const fp = await sha1Hex(c);
        const ids = fpIndex.has(fp) ? Array.from(fpIndex.get(fp)).sort() : [];
        for (const tr of TBL.querySelectorAll("tr")) tr.classList.remove("highlight");
        if (ids.length === 0) {
          alert("NOT FOUND in registry");
          return;
        }
        const idSet = new Set(ids);
        for (const tr of TBL.querySelectorAll("tr")) {
          const idCell = tr.querySelector("td code");
          if (idCell && idSet.has(idCell.textContent)) tr.classList.add("highlight");
        }
        alert("FOUND: " + ids.join(", "));
      }

      async function loadCsv() {
        const res = await fetch("https://raw.githubusercontent.com/theislab/spatialdata-db-curation/main/registry/datasets.csv", { cache: "no-store" });
        const csvText = await res.text();
        const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
        rows = parsed.data;
        buildFingerprintIndex(rows);
        render(rows);
      }

      Q.addEventListener("input", () => render(rows));
      BTN.addEventListener("click", () => { checkSource(); });
      SRC.addEventListener("keydown", e => { if (e.key === "Enter") checkSource(); });

      loadCsv();
    </script>
  </div>
</main>